{% extends "base.html" %}
{% load static %}
{% load widget_tweaks %}

{% block title %}Inventory : {% if object.id %}Edit{% else %}New{% endif %} Item{% endblock %}

{% block content %}
{# TODO: Popup to create missing Category without leaving this page. #}
{# http://localhost:8000/static/admin/js/admin/RelatedObjectLookups.js #}
<form method="post">
    {% csrf_token %}
    <div>
        {{ form.non_form_errors }}
        {{ form.non_field_errors }}
        {% for hidden_field in form.hidden_fields %}
            {{ hidden_field }}
        {% endfor %}
    </div>
    <div class="form-group">
        <label for="{{ form.name.id_for_label }}">{{ form.name.label }}</label>
        {% render_field form.name placeholder=form.name.label data-bob="hi" %}
        {% for error in form.name.errors %}
            <span class="help-block">{{ error }}</span>
        {% endfor %}
    </div>
    <div class="form-group">
        <label for="{{ form.description.id_for_label }}">{{ form.description.label }}</label>
        {{ form.description }}
        {% for error in form.description.errors %}
            <span class="help-block">{{ error }}</span>
        {% endfor %}
    </div>
    <div class="form-group">
        <label for="{{ form.category.id_for_label }}">{{ form.category.label }}</label>
        {{ form.category }}
        {% for error in form.category.errors %}
            <span class="help-block">{{ error }}</span>
        {% endfor %}
        <a class="my-pop-up" href="{% url "inventory:category_create" %}"
           data-control="{{ form.category.id_for_label }}" data-refresh-url="{% url "inventory:api_category" %}">
            <img src="{% static "admin/img/icon-addlink.svg" %}" alt="" width="18" height="18">
        </a>
    </div>
    <input type="submit" value="Save">
</form>
{% if object.id %}
<div>
    <a href="{% url "inventory:item_detail" pk=object.id %}">Cancel</a>
</div>
{% endif %}
<div>
    <a href="{% url "inventory:item_list" %}">Cancel and go back to list</a>
</div>
{% endblock %}

{% block body_scripts %}
<script src="{% static "js/not_jquery.js" %}"></script>
<script>
// `ready(...)` is in not_jquery.js and is a replacement for jQuery's `$(document).ready(...)`.
ready(main);

let refresh_because_of_popup = null;
let refresh_popup_url = null;

function main() {
    let el = document.getElementsByClassName("my-pop-up")[0];
    el.addEventListener("click", popup_event);

    // The CategoryCreateView calls "window.opener.postMessage" which triggers a "message" event.
    window.addEventListener("message", handle_popup_close);
}

function popup_event(e) {
    e.preventDefault();
    let a_tag = e.target.parentNode;
    refresh_because_of_popup = document.getElementById(a_tag.dataset.control);
    refresh_popup_url = a_tag.dataset.refreshUrl;
    const href = new URL(a_tag.href);
    href.searchParams.set('_popup', 1);
    const win = window.open(href, "What's in a name?", 'height=250,width=600,resizable=yes,scrollbars=yes');
    win.focus();
}
async function handle_popup_close(e) {
    if (e.origin !== "{{request.scheme}}://{{request.get_host}}") return;
    let new_id = JSON.parse(e.data);
    const response = await fetch(refresh_popup_url);
    const refreshed_data = await response.json();

    // empty the select control of all options.
    refresh_because_of_popup.innerHTML = "";
    refreshed_data.forEach((e, i) => {
        let is_selected = "";
        if (e.id === new_id.id) {
            is_selected = " selected";
        }
        refresh_because_of_popup.appendChild(
            generateElements(`<option value="${e.id}"${is_selected}>${e.name}</option>`)[0]);
    });
}

</script>
{% endblock %}