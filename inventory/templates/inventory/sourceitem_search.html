{% extends "base.html" %}
{% load static %}

{% block title %}Inventory : Source Item Search{% endblock %}

{% block content %}
<form id="search_form">
<div>
<label for="search_name">Name:</label>
<input type="text" id="search_name" data-search-field="name" placeholder="name">
</div>
<div>
<label for="search_name2">Second Name:</label>
<input type="text" id="search_name2" data-search-field="name" placeholder="name">
</div>
<div>
<label for="search_exclude_name">Exclude Name:</label>
<input type="text" id="search_exclude_name" data-search-field="-name" placeholder="exclude name">
</div>
<div>
<label for="search_exclude_name2">Second Exclude Name:</label>
<input type="text" id="search_exclude_name2" data-search-field="-name" placeholder="exclude name">
</div>
<div>
<label for="search_code">Code:</label>
<input type="text" id="search_code" data-search-field="code" placeholder="code">
</div>
<div>
    <span>
    <input type="checkbox" id="result_style_selector_div" name="result_style_selector" value="div" checked="checked" />
    <label for="result_style_selector_div">Div</label>
    </span>
    <span>
    <input type="checkbox" id="result_style_selector_ul" name="result_style_selector" value="ul" />
    <label for="result_style_selector_ul">List</label>
    </span>
    <span>
    <input type="checkbox" id="result_style_selector_table" name="result_style_selector" value="table" />
    <label for="result_style_selector_table">Table</label>
    </span>
    <span>
    <input type="checkbox" id="result_style_selector_table_multiline" name="result_style_selector" value="table-multiline" />
    <label for="result_style_selector_table_multiline">Multiline Table</label>
    </span>
</div>
</form>
<div id="results_in_table_multiline" style="display: none;">
<hr />
Results in a table with multi-line rows.
<table style="display: none;">
<tbody>
    <tr id="srch_no_result_template_tablerow_ml">
        <td colspan="*">No results</td>
    </tr>
    <tr id="srch_result_template_tablerow_ml">
        <td data-field="id">__id__</td>
        <td data-field="source">__source__</td>
        <td data-field="item_category">__item_category__</td>
        <td data-field="item_description">__item_description__</td>
        <td data-field="item_name">__item_name__</td>
        <td data-field="brand">__brand__</td>
        <td data-field="source_category">__source_category__</td>
        <td data-field="unit_size_unit">__unit_size_unit__</td>
        <td data-field="unit_size_amount">__unit_size_amount__</td>
    </tr>
    <tr id="srch_result_template_tablerow_ml2">
        <td data-field="subunit_size_unit">__subunit_size_unit__</td>
        <td data-field="subunit_size_amount">__subunit_size_amount__</td>
        <td data-field="active">__active__</td>
        <td data-field="quantity">__quantity__</td>
        <td data-field="allow_split_pack">__allow_split_pack__</td>
        <td data-field="cryptic_name">__cryptic_name__</td>
        <td data-field="expanded_name">__expanded_name__</td>
        <td data-field="common_name">__common_name__</td>
        <td data-field="item_number">__item_number__</td>
        <td data-field="extra_number">__extra_number__</td>
    </tr>
</tbody>
</table>
<table>
<thead>
    <tr>
        <th>id</th>
        <th>source</th>
        <th>item category</th>
        <th>item description</th>
        <th>item name</th>
        <th>brand</th>
        <th>source category</th>
        <th>unit size unit</th>
        <th>unit size amount</th>
    </tr>
    <tr>
        <th>subunit size unit</th>
        <th>subunit size amount</th>
        <th>active</th>
        <th>quantity</th>
        <th>allow split pack</th>
        <th>cryptic name</th>
        <th>expanded name</th>
        <th>common name</th>
        <th>item number</th>
        <th>extra number</th>
    </tr>
</thead>
<tbody id="search_results_table_ml">
</tbody>
</table>

</div>
<div id="results_in_table" style="display: none;">
<hr />
Results in a table
<table style="display: none;">
<tbody>
    <tr id="srch_no_result_template_tablerow">
        <td colspan="*">No results</td>
    </tr>
    <tr id="srch_result_template_tablerow">
        <td data-field="id">__id__</td>
        <td data-field="source">__source__</td>
        <td data-field="item_category">__item_category__</td>
        <td data-field="item_description">__item_description__</td>
        <td data-field="item_name">__item_name__</td>
        <td data-field="brand">__brand__</td>
        <td data-field="source_category">__source_category__</td>
        <td data-field="unit_size_unit">__unit_size_unit__</td>
        <td data-field="unit_size_amount">__unit_size_amount__</td>
        <td data-field="subunit_size_unit">__subunit_size_unit__</td>
        <td data-field="subunit_size_amount">__subunit_size_amount__</td>
        <td data-field="active">__active__</td>
        <td data-field="quantity">__quantity__</td>
        <td data-field="allow_split_pack">__allow_split_pack__</td>
        <td data-field="cryptic_name">__cryptic_name__</td>
        <td data-field="expanded_name">__expanded_name__</td>
        <td data-field="common_name">__common_name__</td>
        <td data-field="item_number">__item_number__</td>
        <td data-field="extra_number">__extra_number__</td>
    </tr>
</tbody>
</table>
<table>
<thead>
    <tr>
        <th>id</th>
        <th>source</th>
        <th>item category</th>
        <th>item description</th>
        <th>item name</th>
        <th>brand</th>
        <th>source category</th>
        <th>unit size unit</th>
        <th>unit size amount</th>
        <th>subunit size unit</th>
        <th>subunit size amount</th>
        <th>active</th>
        <th>quantity</th>
        <th>allow split pack</th>
        <th>cryptic name</th>
        <th>expanded name</th>
        <th>common name</th>
        <th>item number</th>
        <th>extra number</th>
    </tr>
</thead>
<tbody id="search_results_table">
</tbody>
</table>
</div>
<div id="results_in_ul" style="display: none;">
<hr />
Results in a ul.
<ul>
<li id="srch_result_template_ul" style="display: none;">
    <span data-field="id">__id__</span>
    <span data-field="source">__source__</span>
    <span data-field="item_category">__item_category__</span>
    <span data-field="item_description">__item_description__</span>
    <span data-field="item_name">__item_name__</span>
    <span data-field="brand">__brand__</span>
    <span data-field="source_category">__source_category__</span>
    <span data-field="unit_size_unit">__unit_size_unit__</span>
    <span data-field="unit_size_amount">__unit_size_amount__</span>
    <span data-field="subunit_size_unit">__subunit_size_unit__</span>
    <span data-field="subunit_size_amount">__subunit_size_amount__</span>
    <span data-field="active">__active__</span>
    <span data-field="quantity">__quantity__</span>
    <span data-field="allow_split_pack">__allow_split_pack__</span>
    <span data-field="cryptic_name">__cryptic_name__</span>
    <span data-field="expanded_name">__expanded_name__</span>
    <span data-field="common_name">__common_name__</span>
    <span data-field="item_number">__item_number__</span>
    <span data-field="extra_number">__extra_number__</span>
</li>
<li id="srch_no_result_template_ul" style="display: none;">
    Nope.
</li>
</ul>
<ul id="search_results_ul">

</ul>
</div>
<div id="results_in_div" style="display: none;">
<hr />
Results in divs
<div id="templates" style="display: none;">
    <div id="srch_result_template_div">
        <span data-field="id">__id__</span>
        <span data-field="source">__source__</span>
        <span data-field="item_category">__item_category__</span>
        <span data-field="item_description">__item_description__</span>
        <span data-field="item_name">__item_name__</span>
    </div>
    <div id="srch_no_result_template_div">
        Nope.
    </div>
</div>
<div id="search_results_div">

</div>
</div>
<hr />
<ul>
<li><a href="{% url "inventory:sourceitem_create" %}">New Source Item</a></li>
<li><a href="{% url "inventory:homepage" %}">Inventory Homepage</a></li>
</ul>
{% endblock %}

{% block body_scripts %}
<script>
let srch_keypress_timer;
let srch_url = "{% url "inventory:api_sourceitem_search" %}";

let result_style = ["ul", "div", "table", "table-multiline"];
let result_style_ids = {
    "div": {
        "container": "results_in_div",
        "results": "search_results_div",
        "template": "srch_result_template_div",
        "no_results_template": "srch_no_result_template_div",
    },
    "ul": {
        "container": "results_in_ul",
        "results": "search_results_ul",
        "template": "srch_result_template_ul",
        "no_results_template": "srch_no_result_template_ul",
    },
    "table": {
        "container": "results_in_table",
        "results": "search_results_table",
        "template": "srch_result_template_tablerow",
        "no_results_template": "srch_no_result_template_tablerow",
    },
    "table-multiline": {
        "container": "results_in_table_multiline",
        "results": "search_results_table_ml",
        "template": ["srch_result_template_tablerow_ml", "srch_result_template_tablerow_ml2"],
        "no_results_template": "srch_no_result_template_tablerow_ml",
    },
}

function srch_get_result_element(_result_style) {
    // The root of the container element for search results.
    return document.getElementById(result_style_ids[_result_style]["results"]);
}
function srch_get_result_element_template(_result_style) {
    // The root of the template used for individual search results.  Always an array even if there is only one element.
    if (Array.isArray(result_style_ids[_result_style]["template"])) {
        let _srch_result_element_template = [];
        for (const id of result_style_ids[_result_style]["template"]) {
            _srch_result_element_template.push(document.getElementById(id));
        }
        return _srch_result_element_template;
    }
    return [document.getElementById(result_style_ids[_result_style]["template"])];
}
function srch_get_no_result_element_template(_result_style) {
    // The root of the template used for indicating no results.
    return document.getElementById(result_style_ids[_result_style]["no_results_template"]);
}
function srch_remove_all_results(_result_style) {
    // Clear any existing search results in preparation for either "No results" or new elements.
    let _srch_results_element = srch_get_result_element(_result_style);
    if (_srch_results_element.firstChild === null) {
        return;
    }
    while( _srch_results_element.firstChild ){
        _srch_results_element.removeChild( _srch_results_element.firstChild );
    }
}
function srch_no_results() {
    for (const _result_style of result_style) {
        srch_remove_all_results(_result_style);
        let new_result = srch_get_no_result_element_template(_result_style).cloneNode(true);
        srch_get_result_element(_result_style).appendChild(new_result);
        new_result.style.display = "";  // "unsetting" display so it inherits rather than forcing 'block' or 'inline-block'
    }
}
function srch_populate_results(data) {
    if (data.length === 0) {
        srch_no_results();
        return;
    }
    for (const _result_style of result_style) {
        srch_remove_all_results(_result_style);
        for (const item of data) {
            srch_add_result(item, _result_style);
        }
    }
}
function srch_add_result(item_to_add, _result_style) {
    for (const template_element of srch_get_result_element_template(_result_style)) {
        let new_result = template_element.cloneNode(true);
        for (const element of new_result.querySelectorAll("[data-field]")) {
            element.innerHTML = item_to_add[element.dataset.field];
        }
        new_result.removeAttribute("id");
        srch_get_result_element(_result_style).appendChild(new_result);
        new_result.style.display = "";  // "unsetting" display so it inherits rather than forcing 'block' or 'inline-block'
    }
}
function srch_get_search_elements() {
    const form = document.getElementById("search_form");
    return form.querySelectorAll("[data-search-field]");
}
function srch_get_values_to_send() {
    let values_to_send = {
        empty: true,
        "search_terms": []
    };
    for (const element of srch_get_search_elements()) {
        if (element.value !== "") {
            // console.log(`${element.dataset.searchField}, "${element.value}"`);
            values_to_send.search_terms.push({key: element.dataset.searchField, value: element.value});
            values_to_send.empty = false;
        }
    }
    return values_to_send;
}
function srch_convert_values_to_query_string(values_to_send) {
    const params = new URLSearchParams();
    for (const pair of values_to_send.search_terms) {
        // console.log(`search_terms: ${pair.key} = ${pair.value}`);
        params.append(pair.key, pair.value);
    }
    let param_string = params.toString();
    // console.log(`param_string = "${param_string}"`)
    return param_string;
}
function srch_timer_elapsed_func(caller_obj) {
    let values_to_send = srch_get_values_to_send();
    if (values_to_send.empty) {
        srch_no_results();
        return;
    }
    let query_string = srch_convert_values_to_query_string(values_to_send)
    const xhttp = new XMLHttpRequest();
    xhttp.onload = function() {
        let data = JSON.parse(this.responseText);
        {#srch_results_element.innerHTML = this.responseText;#}
        srch_populate_results(data);
    }
    xhttp.open("GET", srch_url + "?" + query_string, true);
    xhttp.send();
}
function srch_key_is_visible(e) {
    let donot_ignore = [
        "Backspace", "Space", "Backquote", "Equal", "Minus", "Backslash", "BracketRight", "BracketLeft", "Quote",
        "Semicolon", "Slash", "Period", "Comma",
        "KeyA", "KeyB", "KeyC", "KeyD", "KeyE", "KeyF", "KeyG", "KeyH", "KeyI", "KeyJ", "KeyK", "KeyL", "KeyM",
        "KeyN", "KeyO", "KeyP", "KeyQ", "KeyR", "KeyS", "KeyT", "KeyU", "KeyV", "KeyW", "KeyX", "KeyY", "KeyZ",
        "Digit1", "Digit2", "Digit3", "Digit4", "Digit5", "Digit6", "Digit7", "Digit8", "Digit9", "Digit0",
    ]
    return donot_ignore.includes(e.code);
}
function srch_key_is_not_visible(e) {
    let ignore = [
        'ShiftLeft', 'MetaLeft', 'AltLeft', 'ControlLeft',
        'ShiftRight', 'MetaRight', 'AltRight', 'ControlRight',
        'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown',
        'Enter', 'Tab', 'CapsLock',
        "F1", "F2", "F3", "F4", "F5", "F6", "F7", "F8", "F9", "F10", "F11", "F12"
    ]
    return ignore.includes(e.code);
}
function srch_filter_keydown(e) {
    if (srch_key_is_visible(e)){
        srch_start_timer();
    } else if (!srch_key_is_not_visible(e)) {
        srch_start_timer();
    }
}
function input_focusout() {
    // logit(" > clear timer from focusout");
    window.clearTimeout(srch_keypress_timer);
}
function srch_update_result_style() {
    result_style = [];
    for (const element of document.querySelectorAll("[name=result_style_selector]")) {
        if (element.checked) {
            result_style.push(element.value);
            console.log(`element: "${element.name}" "${element.id}" "${element.value}"`);
            document.getElementById(result_style_ids[element.value]["container"]).style.display = "";
        } else {
            document.getElementById(result_style_ids[element.value]["container"]).style.display = "none";
        }
    }
    srch_start_timer();
}
function srch_setup_events() {
    for (const element of srch_get_search_elements()) {
        if ((element.tagName === "INPUT") && (element.type === "text")) {
            console.log(`Found text input: "${element.dataset.searchField}"`);
            // keydown and focusout events
            element.addEventListener('keydown', (event) => {
                srch_filter_keydown(event);
            });
            element.addEventListener('focusout', (event) => {
                input_focusout();
            });
        }
        if ((element.tagName === "INPUT") && (element.type === "checkbox")) {
            console.log(`Found checkbox input: "${element.dataset.searchField}"`);
            element.addEventListener('onclick', (event) => {
                srch_start_timer();
            });
        }
    }
    for (const element of document.querySelectorAll("[name=result_style_selector]")) {
        element.addEventListener('change', (event) => {
            srch_update_result_style();
        });
    }
}
function srch_start_timer() {
    console.log("Start a timer.");
    window.clearTimeout(srch_keypress_timer);
    srch_keypress_timer = setTimeout(srch_timer_elapsed_func, 750);
}

(function() {
    // onload based on https://stackoverflow.com/a/9899701
    srch_setup_events();
    srch_no_results();
    srch_update_result_style();
})();
</script>

{% endblock %}