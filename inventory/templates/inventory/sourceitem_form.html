{% extends "base.html" %}
{% load static %}
{% load widget_tweaks %}

{% block title %}Inventory : {% if object.id %}Edit{% else %}New{% endif %} Source Item{% endblock %}

{% block styles %}
{{ form.media.css }}
<style>
.custom-field-wrapper {
    margin-top: 0.75em;
    margin-bottom: 0.75em;
}
.helptext {
    color: #777;
}
</style>

{% endblock %}

{% block breadcrumb %}
    <div><a href="{% url "inventory:sourceitem_search" %}">Search Source Item</a></div>
{% endblock %}

{% block content %}
<form method="post" id="source_item_form">
    {% csrf_token %}
    {% for field in form %}
        <div class="custom-field-wrapper">
            {{ field.label_tag }}
            {% if field.id_for_label == "id_item" %}
                {{ field|attr:"data-search-template-id:search_result_template_div"|attr:"data-search-no-results-template-id:search_no_result_template_div"|attr:"data-selected-template-id:selected_template_div" }}
            {% else %}
                {{ field }}
            {% endif %}
            {% if not popup and field.id_for_label in "id_unit_size,id_subunit_size" %}
                <a class="my-pop-up" href="{% url "inventory:unitsize_create" %}"
                   data-control="{{ field.id_for_label }}" data-refresh-url="{% url "inventory:api_unitsize" %}"
                   data-refresh-visible-fn="format_unit_size">
                    <img src="{% static "admin/img/icon-addlink.svg" %}" alt="" width="18" height="18">
                </a>
            {% endif %}
            {% if not popup and field.id_for_label == "id_item" %}
                <a class="my-pop-up" href="{% url "inventory:item_create" %}"
                   data-control="{{ field.id_for_label }}"
                   data-refresh-url="{% url "inventory:api_item" %}?all_objects=1"
                   data-refresh-visible-fn="format_item">
                    <img src="{% static "admin/img/icon-addlink.svg" %}" alt="" width="18" height="18">
                </a>
            {% endif %}
            {% if field.help_text %}
                <span class="helptext" id="{{ field.id_for_label }}_helptext">{{ field.help_text }}</span>
            {% endif %}
            {% for error in field.errors %}
                <span class="error-message">{{ error }}</span>
            {% endfor %}
        </div>
    {% endfor %}
    <input type="submit" value="Save">
</form>

{% if object.id %}
<div>
    <a href="{% url "inventory:sourceitem_detail" pk=object.id %}">Cancel</a>
</div>
{% endif %}
{% if not popup %}
<div>
    <a href="{% url "inventory:sourceitem_list" %}">Cancel and go back to list</a>
</div>
{% endif %}
<div id="templates" style="display: none;">
    <div class="search_result" id="search_result_template_div">
        <a class="search_result_clicky">
            <span style="display: none;" data-copy-to="id_item" data-field="id">__id__</span>
            <span data-field="category">__category__</span>
            |
            <span data-field="name">__name__</span>
            |
            <span data-field="description">__description__</span>
        </a>
    </div>
    <div id="search_no_result_template_div">
        Nope.
    </div>
    <div id="selected_template_div">
        <span data-id="category"></span>
        |
        <span data-id="name"></span>
        |
        <span data-id="description"></span>
    </div>
</div>
{% endblock %}

{% block body_scripts %}
<script src="{% static "js/popup_create.js" %}"></script>
{{ form.media.js }}
<script>
// `ready(...)` is in not_jquery.js and is a replacement for jQuery's `$(document).ready(...)`.
srch_form_id = "source_item_form";
srch_url = "{% url "inventory:api_item" %}";

ready(popup_create_setup);
function format_item(e) {
    return `(${e["category"]}) ${e["name"]}`;
}
function format_unit_size(e) {
    return `${e["amount"]} ${e["unit"]}`;
}
</script>
{% endblock %}
