{% extends "base.html" %}
{% load static %}
{% load humanize %}
{% load fractions %}

{% block title %}Meal Planning : Recipe{% endblock %}

{% block styles %}
<style>
#priced_ingredients {
    border-collapse: collapse;
}
#priced_ingredients th {
    background-color: lightgray;
    border: black solid 1px;
}
#priced_ingredients td {
    border: black solid 1px;
    padding-left: 0.5em;
    padding-right: 0.5em;
}
</style>

{% endblock %}

{% block content %}
<div>Recipe: {{ object.name }}</div>
<div>Description: {{ object.description }}</div>
<div>Goes with: {{ object.goes_with }}</div>
<div>
<form method="get">
    <label for="as_of_date_select">Limit pricing up to:</label>
    <select name="as_of_date" id="as_of_date_select">
        <option value="">Current</option>
        {% for date_label, date_option in date_options.items %}
        <option value="{{ date_option|date:"Y-m-d" }}">{{ date_label }} ({{ date_option }})</option>
        {% endfor %}
    </select>
    <button type="submit" value="a" name="as_of_date_form" id="c">Limit Pricing</button>
</form>
<table id="priced_ingredients">
<thead>
<tr>
    <th>Ingredient</th>
    <th>Amount</th>
    <th>Price</th>
    <th>Price per unit</th>
    <th>Price per purchase unit</th>
    <th>Order Date</th>
    {% for rm in recipe.multipliers.all %}
        <th colspan="3">
            <a href="{% url "meal_planning:recipe_multiplier_detail" recipe_pk=recipe.id pk=rm.id %}">
                {% display_fraction rm.base_multiplier limit_denominator=16 coerce_thirds=True %}x
            </a>
        </th>
    {% endfor %}
</tr>
{% if recipe.multipliers.count %}
<tr>
<th colspan="6"></th>
    {% for rm in recipe.multipliers.all %}
        <th>Amount</th>
        <th>Price</th>
        <th>Adjustment</th>
    {% endfor %}
</tr>
{% endif %}
</thead>
<tbody>
{% for ig_name, ingredient_group_detail in ingredient_groups_with_price.items %}
    <tr>
        <td colspan="6">
            <a href="{% url "meal_planning:recipe_ingredient_group_detail" recipe_pk=object.id pk=ingredient_group_detail.ingredient_group.id %}">{{ ig_name }}</a>
            Group Total: ${{ ingredient_group_detail.total|floatformat:2|intcomma }}
        </td>
        {% for multiplier_total in ingredient_group_detail.multiplier_totals %}
            <td colspan="3">
                Group Total: ${{ multiplier_total|floatformat:2|intcomma }}
            </td>
        {% endfor %}
    </tr>
    {% for ingredient in ingredient_group_detail.ingredients %}
        <tr>
            <td><a href="{% url "meal_planning:recipe_ingredient_detail" recipe_pk=object.id pk=ingredient.id %}">{{ ingredient.name }}</a></td>
            <td>{% display_fraction ingredient.unit_amount limit_denominator=16 coerce_thirds=True %} {{ ingredient.unit_size }}</td>
            {% if ingredient.no_pricing_data %}
                <td style="color: gray;" colspan="4">&lt;No pricing data available&gt;</td>
            {% else %}
                <td>${{ ingredient.ingredient_price|floatformat:2|intcomma }}</td>
                <td>${{ ingredient.per_unit_price|floatformat:2|intcomma }} per {{ ingredient.unit_size }}</td>
                <td>${{ ingredient.per_original_unit_price|floatformat:2|intcomma }} per {{ ingredient.original_unit_size }}</td>
                <td>{{ ingredient.order_date }}</td>
                {% for mb in ingredient.multiplied_bits %}
                    <td style="border-left: black solid 2px;">{% display_fraction mb.unit_amount limit_denominator=16 coerce_thirds=True %} {{ ingredient.unit_size }}</td>
                    <td>${{ mb.ingredient_price|floatformat:2|intcomma }}</td>
                    <td>
                        {% if mb.adjustment %}
                            {% display_fraction mb.adjustment limit_denominator=16 coerce_thirds=True %} {{ ingredient.unit_size }}
                        {% endif %}
                    </td>
                {% endfor %}
            {% endif %}
        </tr>
    {% endfor %}
{% endfor %}
<tr>
    <td colspan="6">Total Price: ${{ total_price|floatformat:2|intcomma }}</td>
    {% for multiplier, multiplier_total in multiplier_totals.items %}
        <td colspan="3">Total Price: ${{ multiplier_total|floatformat:2|intcomma }}</td>
    {% endfor %}
</tr>
</tbody>
</table>
</div>
<div>
<form method="post">
    {% csrf_token %}
    <button type="submit" name="duplicate" value="duplicate">Duplicate</button>
</form>
</div>
<div>
<form method="post">
    {% csrf_token %}
    <label for="base_multiplier">Multiplier</label>
    <input type="number" name="base_multiplier" id="base_multiplier" min="1" max="100" step="0.1" />
    <button type="submit" name="multiply" value="multiply">Add Multiplier</button>
</form>
</div>
<ul>
    <li><a href="{% url "meal_planning:recipe_ingredient_create" recipe_pk=object.pk %}">Add ingredient</a></li>
    <li><a href="{% url "meal_planning:recipe_ingredient_group_create" recipe_pk=object.pk %}">Add ingredient group</a></li>
    <li><a href="{% url "meal_planning:recipe_update" pk=object.pk %}">Edit</a></li>
    <li><a href="{% url "meal_planning:recipe_delete" pk=object.pk %}">Delete</a></li>
    {# TODO: Add Multiplier: Should be able to set a base multiplier then add a per-ingredient adjustment.  Reason: Adjusting the base recipe would have all the multipliers automagically adjust.  #}
    <li><a href="{% url "meal_planning:recipe_list" %}">Recipe List</a></li>
</ul>
{% endblock %}
